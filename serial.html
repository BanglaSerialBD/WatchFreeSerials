// --- 1. LANGUAGE TRANSLATIONS (Now with incomplete blocks that will be handled safely) ---
const translations = {
    'en': {
        pageTitle: "WatchBanglaSerial",
        clickToPlay: "Click to Play Video",
        loadingText: "Please wait... Loading",
        enjoyWatching: "💕 Enjoy watching the Serial 💕",
        videoDescription: "💕Enjoy Watching Serials With Our App💕",
        reload: "Reload",
        todaysEpisode: "Today's Episode 📺",
        videoNotFound: 'Video not found for "{keyword}".',
        networkError: "Network error fetching video list.",
        noVideoSelected: "Error: No video selected.",
        play: "Play",
        pause: "Pause",
        resume: "Resume",
        rotateText: "Rotate",
        exitFullscreenText: "Exit",
        fullscreenText: "Fullscreen",
        downloadAppText: "Download App",
        goBackButton: "Go Back",
        playPauseLabel: "Play/Pause",
        rotateLabel: "Toggle Rotation",
        exitFullscreenLabel: "Exit Fullscreen",
        fullscreenLabel: "Toggle Fullscreen",
        downloadPromoText: "Download our app for latest serial updates every day."
    },
    'bn': {
        pageTitle: "বাংলা সিরিয়াল দেখুন",
        clickToPlay: "ভিডিও চালাতে ক্লিক করুন",
        loadingText: "অনুগ্রহ করে অপেক্ষা করুন...",
        enjoyWatching: "💕 সিরিয়াল দেখে উপভোগ করুন 💕",
        videoDescription: "নাটক দেখার অ্যাপটি Download করুণ",
        reload: "পুনরায় লোড করুন",
        todaysEpisode: "আজকের পর্ব 📺",
        videoNotFound: '"{keyword}" এর জন্য ভিডিও খুঁজে পাওয়া যায়নি।',
        networkError: "ভিডিও তালিকা আনতে নেটওয়ার্ক ত্রুটি।",
        noVideoSelected: "ত্রুটি: কোনো ভিডিও নির্বাচন করা হয়নি।",
        play: "চালান",
        pause: "থামান",
        resume: "পুনরায় শুরু",
        rotateText: "ঘোরান",
        exitFullscreenText: "প্রস্থান",
        fullscreenText: "ফুলস্ক্রিন",
        downloadAppText: "অ্যাপ ডাউনলোড করুন",
        goBackButton: "ফিরে যান",
        playPauseLabel: "চালান/থামান",
        rotateLabel: "ঘোরানো টগল করুন",
        exitFullscreenLabel: "ফুলস্ক্রিন থেকে প্রস্থান",
        fullscreenLabel: "ফুলস্ক্রিন টগল করুন",
        downloadPromoText: "নিয়মিত নাটকের পর্ব দেখতে আমাদের App ডাউনলোড করুন।"
    },
    'hi': { // Incomplete pack for India
        pageTitle: "वॉचबांग्लासीरियल",
        loadingText: "कृपया प्रतीक्षा करें... लोड हो रहा है",
        reload: "पुनः लोड करें",
        todaysEpisode: "आज का एपिसोड 📺",
        downloadAppText: "ऐप डाउनलोड करें",
        goBackButton: "वापस जाओ",
        downloadPromoText: "हर दिन नवीनतम सीरियल अपडेट के लिए हमारा ऐप डाउनलोड करें।"
    },
    'ar': { // Incomplete pack for Jordan, Qatar
        pageTitle: "شاهد المسلسل البنغالي",
        loadingText: "ارجوك انتظر... جار التحميل",
        reload: "إعادة تحميل",
        todaysEpisode: "حلقة اليوم 📺",
        downloadAppText: "تنزيل التطبيق",
        goBackButton: "عُد",
        downloadPromoText: "قم بتنزيل تطبيقنا للحصول على آخر تحديثات المسلسلات كل يوم."
    },
    'ms': { // Incomplete pack for Malaysia
        pageTitle: "Tonton Siri Bangla",
        loadingText: "Sila tunggu... Memuatkan",
        reload: "Muat semula",
        todaysEpisode: "Episod Hari Ini 📺",
        downloadAppText: "Muat Turun Apl",
        goBackButton: "Kembali",
        downloadPromoText: "Muat turun aplikasi kami untuk kemas kini siri terkini setiap hari."
    },
    'af': { // Incomplete pack for South Africa
        pageTitle: "Kyk Bangla Serial",
        loadingText: "Wag asseblief... Laai",
        reload: "Herlaai",
        todaysEpisode: "Vandag se Episode 📺",
        downloadAppText: "Laai Toep af",
        goBackButton: "Gaan terug",
        downloadPromoText: "Laai ons toepassing af vir die nuutste reeksopdaterings elke dag."
    }
};

// --- 2. CONFIGURATION & STATE ---
let currentLang = 'en';
const HOMEPAGE_URL = "https://sites.google.com/view/freezeebangla/home";
const APP_IDENTIFIER = 'BanglaSerial/1.0';
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSmoXqtgtdN3hyUR5W37-hc58bcAKQb7szLAaScIGOzKX54s8PGJriL4yGsGYbc9OAOqItVmHNewm9v/pub?gid=1555217981&single=true&output=csv";
const COUNTDOWN_MAX = 100;
const RELOAD_APPEAR_SECONDS = 20;

// --- 3. ELEMENT SELECTORS ---
const initialPlayOverlay = document.getElementById("initial-play-overlay");
const spinnerLoaderScreen = document.getElementById("spinner-loader-screen");
const loaderCountdownText = document.getElementById("loader-countdown-text");
const reloadContainer = document.getElementById("reload-container");
const promoContainer = document.getElementById('download-promo-container'); // Moved selector up
const playerWrapper = document.getElementById("player-wrapper");
const videoTitleContainer = document.getElementById("video-title-container");
const playPauseBtn = document.getElementById("play-pause-btn");
const fullscreenBtn = document.getElementById("fullscreen-btn");
const floatingButtonsContainer = document.getElementById("floating-buttons-container");
const exitFullscreenBtn = document.getElementById("exit-fullscreen-btn");
const rotateBtn = document.getElementById("rotate-btn");
const backBtnBottom = document.getElementById("back-btn-bottom");
const centerPlayPauseBtn = document.getElementById('center-play-pause-btn');
const playIcons = { bottom: document.getElementById("play-icon"), center: document.getElementById("center-play-icon") };
const pauseIcons = { bottom: document.getElementById("pause-icon"), center: document.getElementById("center-pause-icon") };
const playPauseTexts = { bottom: document.getElementById("play-pause-text"), center: document.getElementById("center-play-pause-text") };
const player = new Plyr("#player", { controls: ['progress', 'current-time', 'duration', 'mute', 'volume', 'settings'], tooltips: { controls: true, seek: true } });
let loaderTimerInterval, activityTimer, autoRotateTimer, centerButtonTimer;
let isFirstPlayAttempt = true;
let currentVideoSource = null;
let environment = 'desktop';
let canShowCenterButton = false;
let isInApp = false; // Define this globally

// --- 4. CORE & UI FUNCTIONS (MAJOR FIX HERE) ---
function getBestLanguage() {
    const userLangs = navigator.languages || [navigator.language || 'en'];
    for (const lang of userLangs) {
        const baseLang = lang.split('-')[0];
        if (translations[baseLang]) {
            return baseLang;
        }
    }
    return 'en';
}

// *** CRITICAL FIX: This function is now robust and will not crash the site. ***
function getTranslatedString(key, replacements = {}) {
    const langDict = translations[currentLang];
    const fallbackDict = translations['en'];
    
    // Use the translation from the current language, or fall back to English, or finally fall back to the key itself.
    let text = (langDict && langDict[key] !== undefined) ? langDict[key] : fallbackDict[key] || key;

    for (const placeholder in replacements) {
        text = text.replace(`{${placeholder}}`, replacements[placeholder]);
    }
    return text;
}

function applyTranslations() {
    document.documentElement.lang = currentLang;
    document.title = getTranslatedString('pageTitle');
    
    document.querySelectorAll('[data-translate-key]').forEach(el => {
        el.textContent = getTranslatedString(el.dataset.translateKey);
    });

    document.querySelectorAll('[data-translate-aria-key]').forEach(el => {
        el.setAttribute('aria-label', getTranslatedString(el.dataset.translateAriaKey));
    });

    // Translate the new promo text safely
    document.getElementById('download-promo-text').textContent = getTranslatedString('downloadPromoText');
}

function getEnvironment() { return 'ontouchstart' in window || navigator.maxTouchPoints > 0 ? 'mobile' : 'desktop'; }
function isPlayerInFullscreen() { return player.fullscreen.active || playerWrapper.classList.contains('simulated-fullscreen'); }

function updateFloatingButtonsVisibility(isInitial) { 
    clearTimeout(activityTimer); 
    if (isPlayerInFullscreen()) { 
        floatingButtonsContainer.classList.remove('hidden'); 
        rotateBtn.classList.toggle('hidden', environment === 'desktop'); 
        const hideDelay = isInitial === true ? 1500 : 1500; 
        activityTimer = setTimeout(() => floatingButtonsContainer.classList.add('hidden'), hideDelay); 
    } else { 
        floatingButtonsContainer.classList.add('hidden'); 
        playerWrapper.classList.remove('force-rotate'); 
        clearTimeout(autoRotateTimer); 
    } 
}

function updateCenterButtonVisibility() { 
    if (!canShowCenterButton) return;
    clearTimeout(centerButtonTimer); 
    centerPlayPauseBtn.classList.add('visible'); 
    centerButtonTimer = setTimeout(() => centerPlayPauseBtn.classList.remove('visible'), 1500); 
}

function syncAllPlayPauseButtons() {
    const isPaused = player.paused;
    const text = isPaused ? getTranslatedString('play') : getTranslatedString('pause'); // Changed to 'play' on pause
    ['bottom', 'center'].forEach(key => {
        playIcons[key].classList.toggle('hidden', !isPaused);
        pauseIcons[key].classList.toggle('hidden', isPaused);
        playPauseTexts[key].textContent = text;
    });
}

function intelligentRotation() { 
    if (window.matchMedia("(orientation: landscape)").matches) { return; } 
    playerWrapper.classList.add('force-rotate'); 
} 
function handleEnterFullscreen() { 
    updateFloatingButtonsVisibility(true); 
    if (environment !== 'desktop') { 
        autoRotateTimer = setTimeout(intelligentRotation, 2000); 
    } 
} 
function handleExitFullscreen() { 
    updateFloatingButtonsVisibility(false); 
    if (screen.orientation && screen.orientation.unlock) screen.orientation.unlock(); 
}

// --- 5. DATA FETCHING (Unchanged) ---
async function fetchVideoData(videoKeyword) { const cacheKey = `video_data_csv`; const timestampKey = `video_data_timestamp`; const CACHE_DURATION_MS = 2 * 60 * 60 * 1000; try { const cachedData = sessionStorage.getItem(cacheKey); const cachedTimestamp = sessionStorage.getItem(timestampKey); let csvText; if (cachedData && cachedTimestamp && (Date.now() - cachedTimestamp < CACHE_DURATION_MS)) { csvText = cachedData; } else { const response = await fetch(SHEET_CSV_URL, { cache: 'no-store' }); if (!response.ok) throw new Error(getTranslatedString('networkError')); csvText = await response.text(); sessionStorage.setItem(cacheKey, csvText); sessionStorage.setItem(timestampKey, String(Date.now())); } const videoRow = csvText.split("\n").map(line => line.split(",")).find(row => row[0] && row[0].trim().toLowerCase() === videoKeyword.trim().toLowerCase()); if (videoRow && videoRow[1]) { return { videoUrl: videoRow[1].trim(), posterUrl: videoRow[2]?.trim() || "" }; } throw new Error(getTranslatedString('videoNotFound', { keyword: videoKeyword })); } catch (error) { sessionStorage.removeItem(cacheKey); sessionStorage.removeItem(timestampKey); throw error; } }

// --- 6. PLAYBACK & LOADER LOGIC ---
function startLoader(isRetry = false) {
    clearInterval(loaderTimerInterval);
    spinnerLoaderScreen.classList.remove('hidden');
    reloadContainer.classList.remove('visible');
    
    if (promoContainer) promoContainer.classList.remove('visible'); // Hide promo on start

    spinnerLoaderScreen.classList.toggle('retry-mode', isRetry);
    let count = 0;
    loaderCountdownText.textContent = `${getTranslatedString('loadingText')} (${count}s)`;

    loaderTimerInterval = setInterval(() => {
        count++;
        loaderCountdownText.textContent = `${getTranslatedString('loadingText')} (${count}s)`;
        if (count === RELOAD_APPEAR_SECONDS) {
            reloadContainer.classList.add('visible');
            if (promoContainer && !isInApp) { // Make promo visible at the same time
                promoContainer.classList.add('visible');
            }
        }
        if (count >= COUNTDOWN_MAX) {
            clearInterval(loaderTimerInterval);
        }
    }, 1000);
    player.play();
}

function handlePrimaryPlay() { 
    if (!isFirstPlayAttempt) { 
        player.togglePlay(); return; 
    } 
    initialPlayOverlay.classList.add('hidden'); 
    if (player.muted) player.muted = false; 
    startLoader(false); 
}
function handleReload() { 
    if (currentVideoSource) { 
        player.source = { type: 'video', sources: [] }; 
        setTimeout(() => { 
            player.source = { type: "video", sources: [{ src: currentVideoSource.videoUrl }], poster: currentVideoSource.posterUrl }; 
            startLoader(true); 
        }, 100); 
    } 
}

// --- 7. EVENT LISTENERS & INITIALIZATION ---
function setupEventListeners() {
    document.getElementById('initial-play-btn').addEventListener('click', handlePrimaryPlay);
    document.getElementById('reload-btn').addEventListener('click', handleReload);
    const playerContainer = player.elements.container;

    playerContainer.addEventListener('mousemove', () => { if (!isFirstPlayAttempt) { updateFloatingButtonsVisibility(false); updateCenterButtonVisibility(); } });
    playerContainer.addEventListener('touchstart', () => { if (!isFirstPlayAttempt) { updateFloatingButtonsVisibility(false); updateCenterButtonVisibility(); } }, { passive: true });

    fullscreenBtn.addEventListener('click', () => { if (isPlayerInFullscreen()) { if (playerWrapper.classList.contains('simulated-fullscreen')) { playerWrapper.classList.remove('simulated-fullscreen'); handleExitFullscreen(); } else if (player.fullscreen.active) player.fullscreen.exit(); } else { if (isFirstPlayAttempt) { handlePrimaryPlay(); } else { player.play(); } if (environment === 'desktop') player.fullscreen.enter(); else { playerWrapper.classList.add('simulated-fullscreen'); handleEnterFullscreen(); } } });
    exitFullscreenBtn.addEventListener('click', () => fullscreenBtn.click());
    rotateBtn.addEventListener('click', () => playerWrapper.classList.toggle('force-rotate'));
    backBtnBottom.addEventListener('click', () => { if (window.history.length > 1) { window.history.back(); } else { window.location.href = HOMEPAGE_URL; } });
    playPauseBtn.addEventListener('click', () => { if (isFirstPlayAttempt) { handlePrimaryPlay(); } else { player.togglePlay(); } });
    centerPlayPauseBtn.addEventListener('click', () => { if (isFirstPlayAttempt) { handlePrimaryPlay(); } else { player.togglePlay(); } setTimeout(() => centerPlayPauseBtn.classList.remove('visible'), 1000); });

    player.on('playing', () => {
        if (isFirstPlayAttempt) {
            spinnerLoaderScreen.classList.add('hidden');
            clearInterval(loaderTimerInterval);
            isFirstPlayAttempt = false;
            setTimeout(() => {
                setTimeout(() => { canShowCenterButton = true; }, 30000);
            }, 500);
        }
        syncAllPlayPauseButtons();
    });

    player.on('enterfullscreen', handleEnterFullscreen);
    player.on('exitfullscreen', handleExitFullscreen);
    player.on('pause', syncAllPlayPauseButtons);
    player.on('ready', syncAllPlayPauseButtons);
}

// This function now wraps the entire startup logic.
document.addEventListener('DOMContentLoaded', () => {
    async function main() {
        isInApp = navigator.userAgent.includes(APP_IDENTIFIER);
        currentLang = getBestLanguage();
        environment = getEnvironment();
        
        // This is safe to call now because the DOM is ready.
        applyTranslations();
        setupEventListeners();

        if (isInApp) {
            document.getElementById('download-app-btn').classList.add('hidden');
        }

        const videoKeyword = sessionStorage.getItem('videoKeyword');
        if (!videoKeyword) {
            initialPlayOverlay.innerHTML = `<p style="color:#FF5555;font-size:18px;text-align:center;padding:50px;">${getTranslatedString('noVideoSelected')}</p>`;
            document.getElementById('comments-section').classList.add('hidden');
            return;
        }
        const today = new Date();
        const formattedDate = today.toLocaleDateString(currentLang, { day: 'numeric', month: 'long', year: 'numeric' });
        videoTitleContainer.innerHTML = `<span>${videoKeyword} ${getTranslatedString('todaysEpisode')}</span><span id="date-box">${formattedDate}</span>`;
        
        try {
            const { videoUrl, posterUrl } = await fetchVideoData(videoKeyword);
            currentVideoSource = { videoUrl, posterUrl };
            player.source = { type: "video", sources: [{ src: videoUrl }], poster: posterUrl };
        } catch (error) {
            initialPlayOverlay.innerHTML = `<p style="color:#FF5555;font-size:18px;text-align:center;padding:50px;">${error.message}</p>`;
        }
    }
    
    main();
});
